# Excel转换器项目理解与规则文档

## 项目概述

这是一个专门用于处理WPS OCR识别后的Excel文件转换工具，将单一的包含大量合并单元格的Excel文件转换为标准化的多个输出文件。

## 核心理解

### 输入文件特征

1. **文件来源**：通过WPS OCR识别PDF文件生成的Excel
2. **主要问题**：
   - 大量合并单元格
   - 边框样式混乱
   - 对象类型复杂（富文本、公式等）
   - 数据结构不规整

### 输入文件结构分析

基于`sample/input.xlsx`的分析：

#### 文件布局
- **总行数**：839行，32列
- **第1-777行**：目录页内容
  - 章节标题
  - 页码信息  
  - 大量重复的合并单元格数据
- **第778-839行**：真正的数据区域
  - 包含"一、工作内容："标题
  - 实际的定额数据和工作内容描述

#### 数据区域特征
1. **关键标识行**：
   - `一、工作内容：` - 工作内容表开始
   - `人 材 机 名 称` - 含量表标题行
   - `单位：xxx` - 单位信息行
   - 定额编号模式：`\d+[A-Z]-\d+` （如：1B-1, 2B-84）

2. **数据类型识别**：
   - **工作内容**：包含定额编号+工作描述
   - **附注信息**：包含定额编号+附注说明
   - **子目信息**：层级结构（$符号）+定额信息+价格数据
   - **含量表**：定额编号+材料信息+单价含量数据

### 输出文件要求

#### 最终输出（XLS格式）
1. **工作内容_附注信息.xlsx**
   - 工作内容工作表：编号（逗号分隔的定额号列表），工作内容
   - 附注信息工作表：编号（逗号分隔的定额号列表），附注信息

2. **子目信息.xlsx**
   - symbol列：层级标识（$, $$, $$$, $$$$）
   - 定额号，子目名称，基价，人工，材料，机械，管理费，利润，其他，图片名称

3. **含量表.xlsx**
   - 编号，名称，规格，单位，单价，含量，主材标记，材料号，材料类别，是否有明细

## 核心规则

### 1. 数据完整性原则
- **严格保持数字精度**：不得随意篡改任何数值
- **保持编号格式**：定额编号必须完整保留
- **维护关联关系**：编号与内容的对应关系不能改变

### 2. 数据识别规则

#### 定额编号规则
- **格式**：`\d+[A-Z]-\d+` （数字+字母+连字符+数字）
- **示例**：1B-1, 2B-84, 3B-5, 5B-1, 6B-15, 7B-22
- **用途**：作为数据分组和关联的主键

#### 工作内容识别规则
- **关键词**：包含"工作内容"、"安装"、"测位"、"划线"等
- **格式**：定额编号列表 + 工作描述
- **编号格式**：多个定额号用逗号分隔（如："2B-84,2B-85,2B-86"）

#### 附注信息识别规则
- **关键词**：包含"附注"、"备注"、"未包括"等
- **格式**：定额编号列表 + 附注说明
- **编号格式**：多个定额号用逗号分隔

#### 子目信息识别规则
- **层级标识**：
  - `$` = 章（第一章、第二章）
  - `$$` = 节（第一节、第二节）
  - `$$$` = 大项（一、二、三）
  - `$$$$` = 小项（1.、2.、3.）
  - 空 = 具体定额项目
- **数据列**：定额号，名称，价格相关数据（基价、人工、材料等）

#### 含量表识别规则
- **标题行**：包含"编号"、"名称"、"单位"、"单价"、"含量"
- **数据特征**：每行包含具体的材料信息和数量数据
- **材料类别**：1=主材，2=辅材，3=其他

### 3. 对象处理规则

#### Excel对象类型处理
```typescript
// 处理富文本对象
if ('richText' in value && Array.isArray(value.richText)) {
  return value.richText.map(rt => rt.text || '').join('');
}

// 处理普通文本对象
if ('text' in value) {
  return value.text;
}

// 处理公式结果
if ('result' in value) {
  return value.result;
}

// 处理超链接
if ('hyperlink' in value && 'text' in value) {
  return value.text;
}
```

#### 边框识别规则
- **重要性**：边框标识真实的表格区域边界
- **检查方式**：检查单元格的top、bottom、left、right边框样式
- **区域识别**：连续有边框的单元格组成一个表格区域

### 4. 数据验证规则

#### 必要字段验证
- **工作内容/附注信息**：编号和内容都不能为空，且编号必须符合定额编号格式
- **子目信息**：子目名称不能为空
- **含量表**：编号、名称、单位都不能为空

#### 数据格式转换
- **数字处理**：自动过滤非数字字符，转换为浮点数
- **布尔值处理**：识别"*"、"√"、"是"、"1"、"true"为真值
- **材料类别处理**：1/主材→主材，2/辅材→辅材，其他→其他

### 5. 错误处理策略

#### 常见错误类型
1. **[object Object]问题**：Excel复杂对象未正确转换为字符串
2. **合并单元格问题**：需要获取主单元格的值
3. **边框识别错误**：可能识别到目录页而非数据区域
4. **数据类型误判**：需要多重验证机制

#### 解决方案
1. **对象处理**：使用专门的`processExcelValue`方法
2. **区域验证**：检查区域内容是否包含有效的定额编号
3. **多重识别**：结合关键词、数据模式、列数等多种方式
4. **日志记录**：详细记录每个处理步骤的结果

## 开发注意事项

### 1. 性能考虑
- 大文件处理（839行×32列）需要优化内存使用
- 避免重复遍历，缓存中间结果
- 合理使用并行处理

### 2. 扩展性设计
- 数据提取器模块化，便于适配不同格式
- 配置化的识别规则，便于调整
- 插件化的输出格式支持

### 3. 测试策略
- 使用样本输出文件作为标准对比
- 重点测试边界情况和错误数据
- 验证数据完整性和精度

## 常见问题解决

### Q: 为什么提取的数据都是目录内容？
A: 边框识别可能定位到了目录页区域。需要验证识别的区域是否包含有效的定额编号和关键标题。

### Q: 如何确保数据的准确性？
A: 
1. 严格按照定额编号格式验证数据
2. 与样本输出文件进行对比验证
3. 实施多层验证机制

### Q: 如何处理OCR识别错误？
A: 
1. 增强数据清洗逻辑
2. 提供手动校正接口
3. 记录可疑数据供人工复核

---

**最后更新**：基于`sample/input.xlsx`文件结构分析
**版本**：1.0
**维护者**：Excel转换器项目团队 
